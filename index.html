
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>TreadPro Manager</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0f172a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  
  <!-- Estilos Globales y Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & Babel (UMD) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    body {
      background-color: #0f172a;
      color: #f8fafc;
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: system-ui, -apple-system, sans-serif;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    .pt-safe { padding-top: env(safe-area-inset-top); }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "lucide-react": "https://esm.sh/lucide-react@^0.562.0"
  }
}
</script>
</head>
<body class="bg-slate-900">
  <div id="root">
    <div style="height: 100vh; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;">
      <div style="width: 40px; height: 40px; border: 4px solid #10b981; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
      <p style="color: #94a3b8; font-family: sans-serif; font-weight: bold; letter-spacing: 1px;">CARGANDO TREADPRO...</p>
    </div>
  </div>

  <style> @keyframes spin { to { transform: rotate(360deg); } } </style>

  <script type="text/babel" data-presets="react">
    const { useState, useEffect, useRef, useMemo } = React;
    const { createRoot } = ReactDOM;

    // --- ICONOS SVG (Inline para evitar fallos de librerías) ---
    const IconActivity = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
    );
    const IconPlus = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    );
    const IconChevronRight = ({ size = 24, className = "" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>
    );
    const IconFlame = ({ size = 12, className = "", fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.332-.224-4.218 1.149-5.716C12.418 1.97 14.773 2.5 15.655 5c.783 2.22-1.298 3.504-1.155 5.5.093 1.3.652 2.373 1.134 2.879 1.137 1.192 2.366 1.127 2.366 1.127A8 8 0 1 1 9 5.539c0 .736.334 2.126.826 3.037.195.362.536.637.77.924a2.502 2.502 0 0 1 .581 1.776z"/></svg>
    );
    const IconZap = ({ size = 12, className = "", fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
    );
    const IconPlay = ({ size = 24, fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    );
    const IconPause = ({ size = 24, fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
    );
    const IconSkip = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 4 15 12 5 20 5 4"/><line x1="19" y1="5" x2="19" y2="19"/></svg>
    );
    const IconSquare = ({ size = 20, fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
    );

    // --- SERVICIOS ---
    const audioService = {
      context: null,
      init() {
        if (!this.context) {
          this.context = new (window.AudioContext || window.webkitAudioContext)();
        }
      },
      async resume() {
        this.init();
        if (this.context.state === 'suspended') await this.context.resume();
      },
      beep(freq, dur) {
        if (!this.context || this.context.state !== 'running') return;
        const osc = this.context.createOscillator();
        const gain = this.context.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(freq, this.context.currentTime);
        gain.gain.setValueAtTime(0.1, this.context.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.context.currentTime + dur / 1000);
        osc.connect(gain);
        gain.connect(this.context.destination);
        osc.start();
        osc.stop(this.context.currentTime + dur / 1000);
      }
    };

    const calculateSessionStats = (segments) => {
      let totalCalories = 0;
      let intensitySum = 0;
      segments.forEach(s => {
        const speedMetersPerMin = (s.speed * 1000) / 60;
        const mets = (0.1 * speedMetersPerMin + 1.8 * speedMetersPerMin * (s.incline / 100) + 3.5) / 3.5;
        totalCalories += mets * 75 * (s.duration / 3600);
        intensitySum += (s.speed * 0.6 + s.incline * 0.4) * (s.duration / 60);
      });
      const avg = intensitySum / (segments.reduce((acc, s) => acc + s.duration, 0) / 60 || 1);
      return { 
        calories: Math.round(totalCalories), 
        fatBurnLevel: avg > 8 ? 5 : avg > 6 ? 4 : avg > 4 ? 3 : avg > 2 ? 2 : 1 
      };
    };

    // --- COMPONENTES ---

    const TimerDisplay = ({ seconds, label, size = 'lg', color = 'text-white' }) => {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      const formatted = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      return (
        <div className="flex flex-col items-center">
          <span className="text-[10px] font-bold uppercase tracking-wider text-slate-500 mb-1">{label}</span>
          <span className={`${size === 'lg' ? 'text-6xl sm:text-7xl' : 'text-3xl'} font-black font-mono ${color}`}>
            {formatted}
          </span>
        </div>
      );
    };

    const NumericInput = ({ label, value, onChange, max, step = "1" }) => (
      <div className="flex flex-col">
        <label className="text-[10px] uppercase text-slate-500 font-bold mb-1 text-center">{label}</label>
        <input 
          type="number" step={step} value={value}
          onChange={(e) => {
            const val = parseFloat(e.target.value) || 0;
            onChange(max ? Math.min(max, val) : val);
          }}
          className="bg-slate-900 text-white p-2 rounded border border-slate-700 focus:border-emerald-500 outline-none w-full text-center font-mono font-bold"
        />
      </div>
    );

    const WorkoutRunner = ({ session, onFinish, onCancel }) => {
      const [idx, setIdx] = useState(0);
      const [timeLeft, setTimeLeft] = useState(session.segments[0].duration);
      const [totalElapsed, setTotalElapsed] = useState(0);
      const [isActive, setIsActive] = useState(true);

      const totalDuration = useMemo(() => session.segments.reduce((a, s) => a + s.duration, 0), [session]);
      const isAlarming = timeLeft <= 5 && timeLeft > 0;

      useEffect(() => {
        let timer;
        if (isActive) {
          timer = setInterval(() => {
            setTimeLeft(prev => {
              if (prev <= 1) {
                if (idx < session.segments.length - 1) {
                  const next = idx + 1;
                  setIdx(next);
                  audioService.beep(1200, 500);
                  return session.segments[next].duration;
                } else {
                  setIsActive(false);
                  onFinish();
                  return 0;
                }
              }
              if (prev <= 6) audioService.beep(440, 150);
              return prev - 1;
            });
            setTotalElapsed(prev => prev + 1);
          }, 1000);
        }
        return () => clearInterval(timer);
      }, [isActive, idx, session]);

      const current = session.segments[idx];

      return (
        <div className={`fixed inset-0 z-50 transition-colors ${isAlarming ? 'bg-red-950/80' : 'bg-slate-900'}`}>
          <div className="max-w-md mx-auto h-full flex flex-col p-6">
            <header className="flex justify-between items-center mb-8">
              <div>
                <h2 className="text-xl font-black text-white">{session.name}</h2>
                <p className="text-xs font-bold text-slate-500 uppercase">Tramo {idx + 1} de {session.segments.length}</p>
              </div>
              <button onClick={onCancel} className="p-3 bg-slate-800 rounded-full text-slate-400 active:scale-90"><IconSquare fill="currentColor" /></button>
            </header>

            <div className="mb-8">
              <TimerDisplay seconds={Math.max(0, totalDuration - totalElapsed)} label="Restante Total" size="sm" color="text-emerald-400" />
            </div>

            <div className={`p-12 rounded-3xl border-4 transition-all mb-8 flex items-center justify-center ${isAlarming ? 'border-red-500 bg-red-500/10 scale-105' : 'border-slate-800 bg-slate-800/50'}`}>
              <TimerDisplay seconds={timeLeft} label="Siguiente cambio en..." />
            </div>

            <div className="grid grid-cols-2 gap-4 mb-8">
              <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700 text-center">
                <span className="text-[10px] text-slate-500 uppercase font-black block mb-1">Velocidad</span>
                <span className="text-4xl font-black text-blue-400">{current.speed}<small className="text-xs ml-1">km/h</small></span>
              </div>
              <div className="bg-slate-800 p-5 rounded-2xl border border-slate-700 text-center">
                <span className="text-[10px] text-slate-500 uppercase font-black block mb-1">Inclinación</span>
                <span className="text-4xl font-black text-orange-400">{current.incline}<small className="text-xs ml-1">%</small></span>
              </div>
            </div>

            <div className="mt-auto flex justify-center gap-10 pb-10">
              <button onClick={() => setIsActive(!isActive)} className={`w-20 h-20 rounded-full flex items-center justify-center ${isActive ? 'bg-slate-800 text-white' : 'bg-emerald-500 text-slate-900 shadow-xl shadow-emerald-500/20'}`}>
                {isActive ? <IconPause fill="currentColor" /> : <IconPlay fill="currentColor" />}
              </button>
              <button onClick={() => { if(idx < session.segments.length -1) { setIdx(idx + 1); setTimeLeft(session.segments[idx+1].duration); } else onFinish(); }} className="w-20 h-20 rounded-full bg-slate-800 text-slate-400 border border-slate-700 flex items-center justify-center">
                <IconSkip />
              </button>
            </div>
          </div>
        </div>
      );
    };

    const WorkoutSetup = ({ session, onStart, onBack }) => {
      const [edited, setEdited] = useState({...session, segments: [...session.segments]});
      const stats = calculateSessionStats(edited.segments);

      return (
        <div className="max-w-md mx-auto p-6 pb-32">
          <div className="flex items-center gap-4 mb-6">
            <button onClick={onBack} className="p-2 text-slate-500"><IconChevronRight className="rotate-180" /></button>
            <h1 className="text-2xl font-black">Configurar</h1>
          </div>

          <div className="bg-slate-800 p-6 rounded-3xl mb-8 border border-slate-700 shadow-2xl">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-lg font-bold">{edited.name}</h2>
              <span className="text-[10px] font-black bg-emerald-500/20 text-emerald-500 px-2 py-1 rounded uppercase tracking-tighter">{edited.segments.length} Tramos</span>
            </div>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-slate-900/50 p-3 rounded-xl text-center border border-slate-700/50">
                <span className="text-xl font-bold text-orange-400">{stats.calories} <small className="text-[10px]">KCAL</small></span>
              </div>
              <div className="bg-slate-900/50 p-3 rounded-xl text-center border border-slate-700/50">
                <div className="flex justify-center gap-0.5">
                  {[1,2,3,4,5].map(i => <IconFlame key={i} size={10} className={i <= stats.fatBurnLevel ? 'text-orange-500' : 'text-slate-700'} fill={i <= stats.fatBurnLevel ? 'currentColor' : 'none'} />)}
                </div>
              </div>
            </div>
          </div>

          <div className="space-y-4">
            {edited.segments.map((s, i) => (
              <div key={s.id} className="bg-slate-800/40 p-4 rounded-2xl border border-slate-800">
                <div className="flex justify-between mb-3"><span className="text-[10px] font-black text-slate-600 uppercase">Tramo {i+1}</span></div>
                <div className="grid grid-cols-3 gap-3">
                  <NumericInput label="MIN" value={Math.floor(s.duration / 60)} onChange={m => { const segs = [...edited.segments]; segs[i].duration = (m*60) + (s.duration%60); setEdited({...edited, segments: segs}); }} />
                  <NumericInput label="KM/H" step="0.1" value={s.speed} onChange={v => { const segs = [...edited.segments]; segs[i].speed = v; setEdited({...edited, segments: segs}); }} max={15} />
                  <NumericInput label="% INC" value={s.incline} onChange={v => { const segs = [...edited.segments]; segs[i].incline = v; setEdited({...edited, segments: segs}); }} max={15} />
                </div>
              </div>
            ))}
          </div>

          <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent">
            <button onClick={() => onStart(edited)} className="w-full max-w-md mx-auto bg-emerald-500 text-slate-900 py-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition-all flex items-center justify-center gap-3">
              <IconPlay fill="currentColor" /> INICIAR
            </button>
          </div>
        </div>
      );
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      const [view, setView] = useState('HOME');
      const [session, setSession] = useState(null);

      const DEFAULT_SESSIONS = [
        { id: 'hiit', name: 'HIIT GONZALO', description: 'Entrenamiento de intervalos piramidales.', segments: [{ id: '1', duration: 300, speed: 4, incline: 5 }, { id: '2', duration: 360, speed: 5, incline: 8 }, { id: '3', duration: 360, speed: 5, incline: 12 }, { id: '4', duration: 360, speed: 4, incline: 15 }, { id: '5', duration: 600, speed: 3, incline: 2 }] },
        { id: 'fat', name: 'QUEMA GRASA', description: 'Intensidad constante en zona aeróbica.', segments: [{ id: 'f1', duration: 600, speed: 5.5, incline: 2 }, { id: 'f2', duration: 600, speed: 6, incline: 3 }, { id: 'f3', duration: 600, speed: 5, incline: 1 }] }
      ];

      const start = () => audioService.resume().catch(console.error);

      return (
        <div className="min-h-screen pb-20" onClick={start}>
          {view === 'HOME' && (
            <div className="max-w-md mx-auto p-6">
              <header className="py-12">
                <h1 className="text-4xl font-black tracking-tighter flex items-center gap-2">
                  <IconActivity className="text-emerald-500" size={36} /> TreadPro
                </h1>
                <p className="text-slate-500 font-bold uppercase text-[10px] tracking-widest mt-1">Professional PWA Tracker</p>
              </header>

              <div className="grid gap-4">
                {DEFAULT_SESSIONS.map(s => (
                  <button key={s.id} onClick={() => { setSession(s); setView('SETUP'); start(); }} className="bg-slate-800 p-6 rounded-3xl border border-slate-700 text-left flex items-center justify-between group active:scale-95 transition-all">
                    <div>
                      <h3 className="text-xl font-black mb-1 group-active:text-emerald-400">{s.name}</h3>
                      <p className="text-sm text-slate-500 line-clamp-1">{s.description}</p>
                    </div>
                    <IconChevronRight className="text-slate-600 group-active:text-emerald-400" />
                  </button>
                ))}
                <button onClick={() => { setSession({...DEFAULT_SESSIONS[0], name: 'PERSONALIZADA', id: Date.now()}); setView('SETUP'); start(); }} className="mt-4 border-2 border-dashed border-slate-700 p-6 rounded-3xl flex items-center justify-center gap-3 text-slate-500 hover:text-emerald-500 hover:border-emerald-500/50 transition-all">
                  <IconPlus /> <span className="font-bold">NUEVA SESIÓN</span>
                </button>
              </div>
            </div>
          )}

          {view === 'SETUP' && session && <WorkoutSetup session={session} onBack={() => setView('HOME')} onStart={s => { setSession(s); setView('ACTIVE'); }} />}
          {view === 'ACTIVE' && session && <WorkoutRunner session={session} onCancel={() => setView('HOME')} onFinish={() => setView('SUMMARY')} />}

          {view === 'SUMMARY' && (
            <div className="fixed inset-0 bg-slate-900 z-[100] flex items-center justify-center p-8 text-center">
              <div className="max-w-sm">
                <div className="w-24 h-24 bg-emerald-500 text-slate-900 rounded-full flex items-center justify-center mx-auto mb-6 shadow-2xl"><IconActivity size={48} /></div>
                <h2 className="text-3xl font-black mb-4 uppercase tracking-tighter">¡Entrenamiento Finalizado!</h2>
                <p className="text-slate-400 mb-10">Has completado todos los tramos de la sesión.</p>
                <button onClick={() => setView('HOME')} className="w-full bg-white text-slate-900 py-5 rounded-2xl font-black text-xl shadow-xl">VOLVER AL INICIO</button>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
